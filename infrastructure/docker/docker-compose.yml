# IFinallyWill - Development Environment
# All services in one compose file
#
# Usage:
#   docker compose up -d                    # Start core services (postgres, redis)
#   docker compose --profile tools up -d    # Include pgAdmin
#   docker compose --profile all up -d      # Start everything

name: ifinallywill

services:
  # ============================================================
  # Core Infrastructure
  # ============================================================

  postgres:
    image: pgvector/pgvector:pg17
    container_name: ifinallywill-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ifinallywill}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ifinallywill_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-ifinallywill}
    ports:
      - '${POSTGRES_PORT:-5434}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-ifinallywill}']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      ifinallywill-network:
        ipv4_address: 172.28.0.10

  redis:
    image: redis:7.4.2-alpine
    container_name: ifinallywill-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-ifinallywill_redis_password}
    ports:
      - '${REDIS_PORT:-6381}:6379'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      ifinallywill-network:
        ipv4_address: 172.28.0.11

  # ============================================================
  # Voice AI Services (VK-Agent + Janus) â€” DEACTIVATED
  # Uncomment to re-enable when voice AI features are needed.
  # ============================================================
  #
  # janus:
  #   image: canyan/janus-gateway:latest
  #   container_name: ifinallywill-janus
  #   restart: unless-stopped
  #   volumes:
  #     - ./janus-configs/janus.jcfg:/usr/local/etc/janus/janus.jcfg:ro
  #     - ./janus-configs/janus.plugin.audiobridge.jcfg:/usr/local/etc/janus/janus.plugin.audiobridge.jcfg:ro
  #     - ./janus-configs/janus.transport.websockets.jcfg:/usr/local/etc/janus/janus.transport.websockets.jcfg:ro
  #   ports:
  #     - "8188:8188"           # WebSocket API
  #     - "8088:8088"           # HTTP Admin
  #     - "10000-10100:10000-10100/udp"  # RTP/RTCP
  #   healthcheck:
  #     test: ['CMD', 'bash', '-c', 'echo > /dev/tcp/localhost/8188 && echo > /dev/tcp/localhost/8088']
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 10s
  #   networks:
  #     ifinallywill-network:
  #       ipv4_address: 172.28.0.20
  #
  # vk-agent:
  #   build:
  #     context: ../../services/vk-agent
  #     dockerfile: Dockerfile
  #   container_name: ifinallywill-vk-agent
  #   restart: unless-stopped
  #   env_file:
  #     - ../../services/vk-agent/.env
  #   environment:
  #     - VK_AGENT_JANUS_WS_URL=ws://ifinallywill-janus:8188
  #     - VK_AGENT_RTP_HOST=172.28.0.21
  #     - VK_AGENT_RTP_PORT=5004
  #   ports:
  #     - "5004:5004/udp"  # RTP audio
  #     - "3004:3004"      # API server
  #   healthcheck:
  #     test: ['CMD', 'curl', '-sf', 'http://localhost:3004/health']
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   depends_on:
  #     janus:
  #       condition: service_healthy
  #   networks:
  #     ifinallywill-network:
  #       ipv4_address: 172.28.0.21

  # ============================================================
  # Development Tools (optional)
  # ============================================================

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ifinallywill-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@ifinallywill.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - '${PGADMIN_PORT:-5050}:80'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    profiles:
      - tools
      - all
    networks:
      - ifinallywill-network

volumes:
  postgres_data:
    name: ifinallywill-postgres-data
  redis_data:
    name: ifinallywill-redis-data
  pgadmin_data:
    name: ifinallywill-pgadmin-data

networks:
  ifinallywill-network:
    name: ifinallywill-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
