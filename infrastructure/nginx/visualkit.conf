# VisualKit Platform - Production Nginx Configuration
#
# Architecture:
# - www.visualkit.live        → Landing page (static/SSR)
# - dashboard.visualkit.live  → Dashboard SPA (React)
# - api.visualkit.live        → Platform API (Fastify + tRPC)
# - support.visualkit.live    → Chatwoot (Rails) - SEPARATE SUBDOMAIN
# - meet.visualkit.live       → Meeting rooms (React + LiveKit)
# - widget.visualkit.live     → Widget SDK (CDN)
#
# Why Chatwoot on separate subdomain?
# - Chatwoot uses /api/* routes that conflict with Platform API
# - Separate subdomain avoids routing conflicts
# - iframe embedding works via FRAME_ANCESTORS CSP

# Upstream definitions
upstream platform_api {
    server platform-api:3001;
    keepalive 32;
}

upstream platform_realtime {
    server platform-realtime:3002;
    keepalive 32;
}

upstream chatwoot {
    server chatwoot:3000;
    keepalive 32;
}

upstream dashboard {
    server dashboard:80;
    keepalive 16;
}

upstream landing {
    server landing:80;
    keepalive 16;
}

upstream meeting {
    server meeting:80;
    keepalive 16;
}

# =============================================================================
# Landing Page - www.visualkit.live
# =============================================================================
server {
    listen 80;
    listen 443 ssl http2;
    server_name www.visualkit.live visualkit.live;

    ssl_certificate /etc/nginx/ssl/visualkit.live.crt;
    ssl_certificate_key /etc/nginx/ssl/visualkit.live.key;

    # Redirect HTTP to HTTPS
    if ($scheme = http) {
        return 301 https://$server_name$request_uri;
    }

    # Redirect non-www to www
    if ($host = visualkit.live) {
        return 301 https://www.visualkit.live$request_uri;
    }

    location / {
        proxy_pass http://landing;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# =============================================================================
# Dashboard - dashboard.visualkit.live
# =============================================================================
server {
    listen 80;
    listen 443 ssl http2;
    server_name dashboard.visualkit.live;

    ssl_certificate /etc/nginx/ssl/visualkit.live.crt;
    ssl_certificate_key /etc/nginx/ssl/visualkit.live.key;

    # Redirect HTTP to HTTPS
    if ($scheme = http) {
        return 301 https://$server_name$request_uri;
    }

    # API requests → Platform API
    location /api {
        proxy_pass http://platform_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Timeout settings for API
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # WebSocket for real-time features
    location /ws {
        proxy_pass http://platform_realtime;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket timeout (keep connection open)
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # Dashboard SPA
    location / {
        proxy_pass http://dashboard;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SPA routing - serve index.html for all routes
        try_files $uri $uri/ /index.html;
    }
}

# =============================================================================
# Chatwoot Support - support.visualkit.live (SEPARATE SUBDOMAIN)
# =============================================================================
server {
    listen 80;
    listen 443 ssl http2;
    server_name support.visualkit.live;

    ssl_certificate /etc/nginx/ssl/visualkit.live.crt;
    ssl_certificate_key /etc/nginx/ssl/visualkit.live.key;

    # Redirect HTTP to HTTPS
    if ($scheme = http) {
        return 301 https://$server_name$request_uri;
    }

    # Client max body size for file uploads
    client_max_body_size 50M;

    location / {
        proxy_pass http://chatwoot;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CRITICAL: Remove X-Frame-Options to allow iframe embedding
        # Chatwoot sets its own CSP with FRAME_ANCESTORS
        proxy_hide_header X-Frame-Options;

        # WebSocket support for Chatwoot ActionCable
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeout settings
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;
    }

    # Chatwoot ActionCable WebSocket
    location /cable {
        proxy_pass http://chatwoot;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
}

# =============================================================================
# API - api.visualkit.live
# =============================================================================
server {
    listen 80;
    listen 443 ssl http2;
    server_name api.visualkit.live;

    ssl_certificate /etc/nginx/ssl/visualkit.live.crt;
    ssl_certificate_key /etc/nginx/ssl/visualkit.live.key;

    # Redirect HTTP to HTTPS
    if ($scheme = http) {
        return 301 https://$server_name$request_uri;
    }

    location / {
        proxy_pass http://platform_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # CORS headers for API
        add_header Access-Control-Allow-Origin "https://dashboard.visualkit.live" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-CSRF-Token" always;
        add_header Access-Control-Allow-Credentials "true" always;

        # Handle preflight requests
        if ($request_method = OPTIONS) {
            return 204;
        }

        # Timeout settings
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# =============================================================================
# Meeting Rooms - meet.visualkit.live
# =============================================================================
server {
    listen 80;
    listen 443 ssl http2;
    server_name meet.visualkit.live;

    ssl_certificate /etc/nginx/ssl/visualkit.live.crt;
    ssl_certificate_key /etc/nginx/ssl/visualkit.live.key;

    # Redirect HTTP to HTTPS
    if ($scheme = http) {
        return 301 https://$server_name$request_uri;
    }

    location / {
        proxy_pass http://meeting;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SPA routing
        try_files $uri $uri/ /index.html;
    }
}

# =============================================================================
# SSL Configuration (shared)
# =============================================================================
# Place this in a separate ssl.conf and include it:
#
# ssl_protocols TLSv1.2 TLSv1.3;
# ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
# ssl_prefer_server_ciphers off;
# ssl_session_timeout 1d;
# ssl_session_cache shared:SSL:50m;
# ssl_session_tickets off;
# ssl_stapling on;
# ssl_stapling_verify on;
