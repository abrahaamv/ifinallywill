version: '3.9'

services:
  # LiveKit Server
  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml
    ports:
      - "7880:7880"   # WebSocket
      - "7881:7881"   # HTTP
      - "7882:7882"   # gRPC
      - "50000-50100:50000-50100/udp"  # RTP/RTCP
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml
    environment:
      - LIVEKIT_KEYS=devkey: devsecret
    networks:
      - livekit-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7881/"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching and rate limiting
  redis:
    image: redis:7.4.2-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - livekit-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for knowledge base
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: platform
      POSTGRES_USER: platform
      POSTGRES_PASSWORD: platform_dev_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # Uncomment to load schema on first run
      # - ../packages/db/migrations:/docker-entrypoint-initdb.d
    networks:
      - livekit-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U platform"]
      interval: 10s
      timeout: 5s
      retries: 5

  # LiveKit Agent (Python)
  livekit-agent:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      livekit:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      # LiveKit connection
      LIVEKIT_URL: ws://livekit:7880
      LIVEKIT_API_KEY: devkey
      LIVEKIT_API_SECRET: devsecret

      # Backend API
      BACKEND_URL: http://host.docker.internal:3001
      BACKEND_API_KEY: dev_api_key_change_in_production

      # Redis
      REDIS_URL: redis://redis:6379/0

      # PostgreSQL
      DATABASE_URL: postgresql://platform:platform_dev_password@postgres:5432/platform

      # AI Provider API Keys (from host .env)
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      DEEPGRAM_API_KEY: ${DEEPGRAM_API_KEY}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY}
      VOYAGE_API_KEY: ${VOYAGE_API_KEY}

      # Frame processing
      FRAME_SIMILARITY_THRESHOLD: "10"
      ACTIVE_FPS: "30.0"
      IDLE_FPS: "5.0"

      # Tenant routing weights
      GEMINI_FLASH_LITE_WEIGHT: "0.60"
      GEMINI_FLASH_WEIGHT: "0.25"
      CLAUDE_SONNET_WEIGHT: "0.15"

      # Python environment
      PYTHONUNBUFFERED: "1"
    networks:
      - livekit-network
    restart: unless-stopped
    # Scale multiple workers: docker-compose up --scale livekit-agent=3
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

networks:
  livekit-network:
    driver: bridge

volumes:
  redis-data:
  postgres-data:
