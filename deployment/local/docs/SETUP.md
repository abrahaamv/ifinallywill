# Detailed Setup Guide

Complete guide for setting up your local server deployment.

## Prerequisites

### Hardware Requirements

| Spec | Minimum | Recommended |
|------|---------|-------------|
| RAM | 8GB | 16GB |
| CPU | 4 cores (x86_64) | 8 cores |
| Storage | 50GB SSD | 100GB+ NVMe |
| Network | 10 Mbps upload | 50+ Mbps |

### Software Requirements

- **OS**: Ubuntu 22.04 LTS or 24.04 LTS (recommended)
- **Docker**: 24.0+ with Docker Compose v2
- **Git**: 2.40+

## Step 1: Prepare Your Server

### Option A: Fresh Ubuntu Server Install

1. Download Ubuntu Server from [ubuntu.com](https://ubuntu.com/download/server)
2. Create bootable USB with [Balena Etcher](https://etcher.balena.io/)
3. Install Ubuntu Server (minimal installation is fine)
4. Connect to network (Ethernet recommended for servers)

### Option B: Use Existing Ubuntu Desktop

Works fine! Just keep the laptop plugged in and disable sleep:

```bash
# Disable sleep when lid closed
sudo nano /etc/systemd/logind.conf
# Set: HandleLidSwitch=ignore
# Set: HandleLidSwitchDocked=ignore

sudo systemctl restart systemd-logind

# Disable screen blanking
gsettings set org.gnome.desktop.session idle-delay 0
```

## Step 2: Initial Server Setup

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Set hostname (optional but nice)
sudo hostnamectl set-hostname ai-platform-server

# Set timezone
sudo timedatectl set-timezone America/New_York  # Or your timezone

# Create project user (if not using your main user)
sudo adduser platform
sudo usermod -aG sudo platform
su - platform
```

## Step 3: Clone Repository

```bash
cd ~
git clone https://github.com/yourusername/platform.git
cd platform
```

## Step 4: Run Setup Script

```bash
cd deployment/local
chmod +x scripts/*.sh
./scripts/setup.sh
```

This script:
- Installs Docker and Docker Compose
- Installs cloudflared (Cloudflare Tunnel client)
- Configures firewall
- Generates secure passwords

**Important**: Log out and back in after setup (or run `newgrp docker`) for Docker permissions.

## Step 5: Configure Environment

```bash
# Edit environment file
nano .env
```

### Required Configuration

```bash
# Already generated by setup.sh:
POSTGRES_PASSWORD=<auto-generated>
REDIS_PASSWORD=<auto-generated>
SESSION_SECRET=<auto-generated>

# You need to add:
GOOGLE_API_KEY=your-google-ai-key          # For Gemini
LIVEKIT_API_KEY=your-livekit-key
LIVEKIT_API_SECRET=your-livekit-secret
CLOUDFLARE_TUNNEL_TOKEN=your-tunnel-token  # See next section
```

### Generate LiveKit Keys

```bash
docker run --rm livekit/livekit-server generate-keys
```

Copy the output to your `.env` file.

### Get API Keys

| Service | URL | Purpose |
|---------|-----|---------|
| Google AI | [aistudio.google.com](https://aistudio.google.com/apikey) | Gemini Live API |
| OpenAI | [platform.openai.com](https://platform.openai.com/api-keys) | GPT-4 (optional) |
| Anthropic | [console.anthropic.com](https://console.anthropic.com/settings/keys) | Claude (optional) |
| Voyage | [dash.voyageai.com](https://dash.voyageai.com/) | Embeddings |

## Step 6: Set Up Cloudflare Tunnel

See [CLOUDFLARE.md](CLOUDFLARE.md) for detailed instructions.

Quick version:

```bash
# Login to Cloudflare
cloudflared tunnel login

# Create tunnel
cloudflared tunnel create ai-platform

# Get tunnel token from Cloudflare dashboard
# Zero Trust → Networks → Tunnels → ai-platform → Configure

# Add token to .env
echo "CLOUDFLARE_TUNNEL_TOKEN=your-token" >> .env
```

## Step 7: Deploy

```bash
./scripts/deploy.sh
```

This will:
1. Build all Docker images
2. Start databases (PostgreSQL, Redis)
3. Run database migrations
4. Start all services
5. Start Cloudflare Tunnel

## Step 8: Configure Cloudflare Routes

In Cloudflare Dashboard (Zero Trust → Networks → Tunnels):

| Public Hostname | Service | URL |
|-----------------|---------|-----|
| `yourdomain.com` | HTTP | `http://nginx:80` |
| `api.yourdomain.com` | HTTP | `http://nginx:80` |
| `meet.yourdomain.com` | HTTP | `http://nginx:80` |
| `livekit.yourdomain.com` | HTTP | `http://livekit:7880` |

## Step 9: Verify Deployment

```bash
# Check all services
./scripts/status.sh

# View logs
./scripts/logs.sh

# Test locally
curl http://localhost/health
```

## Troubleshooting

### Docker Permission Denied

```bash
# Make sure you're in docker group
groups
# Should include 'docker'

# If not, add yourself
sudo usermod -aG docker $USER
newgrp docker
```

### Port Already in Use

```bash
# Find what's using the port
sudo lsof -i :80

# Kill it or change nginx port in docker-compose.yml
```

### Service Not Starting

```bash
# Check logs for specific service
./scripts/logs.sh api

# Check Docker status
docker compose ps

# Try restarting
docker compose restart api
```

### Database Connection Issues

```bash
# Check PostgreSQL is running
docker compose exec postgres pg_isready

# Check Redis
docker compose exec redis redis-cli ping
```

## Keeping Your Server Running

### Auto-start on Boot

```bash
# Enable Docker auto-start
sudo systemctl enable docker

# Create systemd service for the platform
sudo nano /etc/systemd/system/ai-platform.service
```

```ini
[Unit]
Description=AI Assistant Platform
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/home/platform/platform/deployment/local
ExecStart=/usr/bin/docker compose up -d
ExecStop=/usr/bin/docker compose down
User=platform

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl enable ai-platform
sudo systemctl start ai-platform
```

### Monitor Uptime

```bash
# Add to crontab for auto-restart on failure
crontab -e

# Add line:
*/5 * * * * cd /home/platform/platform/deployment/local && docker compose up -d 2>/dev/null
```

## Next Steps

1. [Set up SSH access](SSH.md) for remote management
2. [Configure Cloudflare Tunnel](CLOUDFLARE.md) for public access
3. Configure your domain DNS
4. Test your deployment!
