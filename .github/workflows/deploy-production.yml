name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.2.3)'
        required: true
        type: string

env:
  PNPM_VERSION: 9.15.4
  HETZNER_HOST: 178.156.151.139
  HETZNER_USER: root
  REMOTE_DIR: /opt/platform

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
      - name: Get version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi

          # Validate version format (e.g., v1.2.3)
          if ! echo "$VERSION" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: v1.2.3"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

  build-and-test:
    name: Build and Test
    needs: validate-release
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-release.outputs.version }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm typecheck

      - name: Run tests
        run: pnpm test

      - name: Build all packages
        run: pnpm build

  build-docker-images:
    name: Build Docker Images
    needs: [validate-release, build-and-test]
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-release.outputs.version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image
        run: |
          docker build -t platform-api:${{ needs.validate-release.outputs.version }} \
            -t platform-api:latest \
            --build-arg VERSION=${{ needs.validate-release.outputs.version }} \
            -f packages/api/Dockerfile .

      - name: Build VK-Agent image
        run: |
          docker build -t platform-vk-agent:${{ needs.validate-release.outputs.version }} \
            -t platform-vk-agent:latest \
            -f services/vk-agent/Dockerfile services/vk-agent/

      - name: Save images
        run: |
          docker save platform-api:latest platform-vk-agent:latest | gzip > images.tar.gz

      - name: Upload images artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: images.tar.gz
          retention-days: 1

  deploy-backend:
    name: Deploy Backend to Hetzner
    needs: [validate-release, build-docker-images]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-release.outputs.version }}

      - name: Download images artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Transfer images to Hetzner
        run: |
          scp images.tar.gz ${{ env.HETZNER_USER }}@${{ env.HETZNER_HOST }}:/tmp/images.tar.gz
          ssh ${{ env.HETZNER_USER }}@${{ env.HETZNER_HOST }} "gunzip -c /tmp/images.tar.gz | docker load && rm /tmp/images.tar.gz"

      - name: Deploy API container
        run: |
          ssh ${{ env.HETZNER_USER }}@${{ env.HETZNER_HOST }} << 'EOF'
          cd ${{ env.REMOTE_DIR }}

          # Stop and remove old API container
          docker stop platform-api 2>/dev/null || true
          docker rm platform-api 2>/dev/null || true

          # Start new API container
          docker run -d \
            --name platform-api \
            --restart unless-stopped \
            --network platform-network \
            -p 3001:3001 \
            -p 3002:3002 \
            --env-file .env \
            platform-api:latest

          # Wait for health check
          echo "Waiting for API health..."
          for i in $(seq 1 12); do
            if curl -sf http://localhost:3001/health > /dev/null; then
              echo "API is healthy!"
              exit 0
            fi
            echo "Waiting... (attempt $i/12)"
            sleep 5
          done
          echo "API health check failed"
          exit 1
          EOF

      - name: Deploy VK-Agent container
        run: |
          ssh ${{ env.HETZNER_USER }}@${{ env.HETZNER_HOST }} << 'EOF'
          cd ${{ env.REMOTE_DIR }}

          # Stop and remove old VK-Agent container
          docker stop platform-vk-agent 2>/dev/null || true
          docker rm platform-vk-agent 2>/dev/null || true

          # Start new VK-Agent container
          docker run -d \
            --name platform-vk-agent \
            --restart unless-stopped \
            --network platform-network \
            -p 3004:3004 \
            -p 5005:5005/udp \
            --env-file .env.agent \
            platform-vk-agent:latest

          # Wait for health check
          echo "Waiting for VK-Agent health..."
          for i in $(seq 1 12); do
            if curl -sf http://localhost:3004/health > /dev/null; then
              echo "VK-Agent is healthy!"
              exit 0
            fi
            echo "Waiting... (attempt $i/12)"
            sleep 5
          done
          echo "VK-Agent health check failed"
          exit 1
          EOF

  health-check:
    name: Post-Deployment Health Check
    needs: [validate-release, deploy-backend]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check API health
        run: |
          for i in $(seq 1 12); do
            if curl -sf https://api.visualkit.live/health | grep -q "ok"; then
              echo "API is healthy via Caddy"
              exit 0
            fi
            echo "Waiting for API (attempt $i/12)..."
            sleep 5
          done
          echo "API health check failed"
          exit 1

      - name: Check VK-Agent health
        run: |
          curl -sf https://agent.visualkit.live/health || {
            echo "VK-Agent health check failed"
            exit 1
          }
          echo "VK-Agent is healthy"

      - name: Check frontend availability
        run: |
          curl -sf https://visualkit.live || {
            echo "Landing page not accessible"
            exit 1
          }
          curl -sf https://app.visualkit.live || {
            echo "Dashboard not accessible"
            exit 1
          }
          echo "All frontends accessible"

  rollback:
    name: Rollback on Failure
    needs: [validate-release, deploy-backend, health-check]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Rollback containers
        run: |
          ssh ${{ env.HETZNER_USER }}@${{ env.HETZNER_HOST }} << 'EOF'
          echo "Rolling back to previous images..."

          # Docker keeps previous image tagged - restart with previous
          for container in platform-api platform-vk-agent; do
            docker stop $container 2>/dev/null || true
            docker rm $container 2>/dev/null || true
          done

          # Restart with previous tagged images (if available)
          cd /opt/platform
          docker compose up -d 2>/dev/null || echo "Manual rollback may be required"

          echo "Rollback attempted - verify services manually"
          EOF

  notify:
    name: Send Deployment Notification
    needs: [validate-release, deploy-backend, health-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Production Deployment ${{ needs.health-check.result == 'success' && 'Success ✅' || 'Failed ❌' }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment ${{ needs.health-check.result == 'success' && '✅ Success' || '❌ Failed' }}*\n\n*Version:* ${{ needs.validate-release.outputs.version }}\n*Target:* Hetzner VPS (${{ env.HETZNER_HOST }})\n*Services:* API + VK-Agent"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
