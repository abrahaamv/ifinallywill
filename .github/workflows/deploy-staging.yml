name: Deploy to Staging

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PNPM_VERSION: 9.15.4
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_STAGING }}
  GCP_REGION: us-central1
  GCP_REGISTRY: gcr.io

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      api-image: ${{ steps.meta-api.outputs.tags }}
      realtime-image: ${{ steps.meta-realtime.outputs.tags }}
      python-agent-image: ${{ steps.meta-python-agent.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GCP_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/api
          tags: |
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: packages/api/Dockerfile
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Extract metadata for Realtime
        id: meta-realtime
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GCP_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/realtime
          tags: |
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: Build and push Realtime image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: packages/realtime/Dockerfile
          push: true
          tags: ${{ steps.meta-realtime.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Extract metadata for Python Agent
        id: meta-python-agent
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GCP_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/python-agent
          tags: |
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: Build and push Python Agent image
        uses: docker/build-push-action@v5
        with:
          context: livekit-agent
          file: livekit-agent/Dockerfile
          push: true
          tags: ${{ steps.meta-python-agent.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

  deploy-backend:
    name: Deploy Backend Services
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        service:
          - name: api
            min-instances: 0
            max-instances: 10
            memory: 2Gi
            cpu: 2
          - name: realtime
            min-instances: 1
            max-instances: 5
            memory: 2Gi
            cpu: 2
          - name: python-agent
            min-instances: 1
            max-instances: 5
            memory: 4Gi
            cpu: 4

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          IMAGE="${{ env.GCP_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ matrix.service.name }}:staging-${{ github.sha }}"

          gcloud run deploy ${{ matrix.service.name }}-staging \
            --image=$IMAGE \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --min-instances=${{ matrix.service.min-instances }} \
            --max-instances=${{ matrix.service.max-instances }} \
            --memory=${{ matrix.service.memory }} \
            --cpu=${{ matrix.service.cpu }} \
            --timeout=300 \
            --concurrency=80 \
            --set-env-vars="NODE_ENV=staging" \
            --set-secrets="DATABASE_URL=DATABASE_URL_STAGING:latest,REDIS_URL=REDIS_URL_STAGING:latest" \
            --vpc-connector=platform-staging-vpc \
            --vpc-egress=private-ranges-only

      - name: Wait for service to stabilize
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ matrix.service.name }}-staging \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')

          echo "Service URL: $SERVICE_URL"

          # Wait up to 2 minutes for health check
          for i in {1..24}; do
            if curl -sf "$SERVICE_URL/health" > /dev/null; then
              echo "Service is healthy!"
              exit 0
            fi
            echo "Waiting for service to become healthy (attempt $i/24)..."
            sleep 5
          done

          echo "Service failed to become healthy"
          exit 1

  deploy-frontend:
    name: Deploy Frontend
    needs: deploy-backend
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend apps
        env:
          VITE_API_URL: https://api-staging.platform.com
          VITE_WS_URL: wss://realtime-staging.platform.com
          VITE_LIVEKIT_URL: wss://livekit-staging.platform.com
        run: pnpm build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload to Cloud Storage
        run: |
          # Landing page
          gsutil -m rsync -r -d apps/landing/dist gs://platform-staging-landing

          # Dashboard
          gsutil -m rsync -r -d apps/dashboard/dist gs://platform-staging-dashboard

          # Meeting
          gsutil -m rsync -r -d apps/meeting/dist gs://platform-staging-meeting

          # Widget SDK
          gsutil -m rsync -r -d apps/widget-sdk/dist gs://platform-staging-widget

      - name: Invalidate CDN cache
        run: |
          gcloud compute url-maps invalidate-cdn-cache platform-staging-lb \
            --path "/*" \
            --async

  health-check:
    name: Post-Deployment Health Check
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check API health
        run: |
          curl -sf https://api-staging.platform.com/health || exit 1
          echo "API is healthy"

      - name: Check WebSocket health
        run: |
          curl -sf https://realtime-staging.platform.com/health || exit 1
          echo "WebSocket server is healthy"

      - name: Check Frontend availability
        run: |
          curl -sf https://staging.platform.com || exit 1
          echo "Frontend is accessible"

      - name: Run smoke tests
        run: |
          # Basic API smoke test
          response=$(curl -s https://api-staging.platform.com/health)
          if echo "$response" | grep -q "ok"; then
            echo "API smoke test passed"
          else
            echo "API smoke test failed"
            exit 1
          fi

  notify:
    name: Send Deployment Notification
    needs: [deploy-backend, deploy-frontend, health-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK_URL }}
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Staging Deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging Deployment ${{ job.status }}*\n\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.sha }}>\n*Author:* ${{ github.event.head_commit.author.name }}\n*Message:* ${{ github.event.head_commit.message }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ needs.health-check.result == 'success' && '✅ Success' || '❌ Failed' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nStaging"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  rollback:
    name: Rollback on Failure
    needs: [deploy-backend, deploy-frontend, health-check]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Rollback Cloud Run services
        run: |
          for service in api realtime python-agent; do
            echo "Rolling back $service-staging..."

            # Get previous revision
            PREVIOUS_REVISION=$(gcloud run revisions list \
              --service=$service-staging \
              --region=${{ env.GCP_REGION }} \
              --format="value(name)" \
              --limit=2 \
              | tail -n 1)

            if [ -n "$PREVIOUS_REVISION" ]; then
              gcloud run services update-traffic $service-staging \
                --region=${{ env.GCP_REGION }} \
                --to-revisions=$PREVIOUS_REVISION=100
              echo "Rolled back $service-staging to $PREVIOUS_REVISION"
            else
              echo "No previous revision found for $service-staging"
            fi
          done

      - name: Send rollback notification
        if: ${{ secrets.SLACK_WEBHOOK_URL }}
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "⚠️ Staging deployment failed and was rolled back",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging Deployment Failed - Rollback Initiated*\n\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.sha }}>\n*Author:* ${{ github.event.head_commit.author.name }}\n\nAll services have been rolled back to their previous stable versions."
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
